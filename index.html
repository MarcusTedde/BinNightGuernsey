<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Bin Night Guernsey</title>
  <meta name="description" content="Know exactly what to put out tonight. Bin collection nights for every address in Guernsey.">
  <meta name="theme-color" content="#060f1c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Bin Night">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='7' fill='%23060f1c'/%3E%3Crect x='9' y='14' width='14' height='13' rx='2' fill='%233db8f5'/%3E%3Crect x='7' y='10' width='18' height='5' rx='2' fill='%233db8f5'/%3E%3Cpath d='M13 7.5 L13 10 M16 6.5 L16 10 M19 7.5 L19 10' stroke='%233db8f5' stroke-width='1.8' stroke-linecap='round'/%3E%3C/svg%3E">
  <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='7' fill='%23060f1c'/%3E%3Crect x='9' y='14' width='14' height='13' rx='2' fill='%233db8f5'/%3E%3Crect x='7' y='10' width='18' height='5' rx='2' fill='%233db8f5'/%3E%3Cpath d='M13 7.5 L13 10 M16 6.5 L16 10 M19 7.5 L19 10' stroke='%233db8f5' stroke-width='1.8' stroke-linecap='round'/%3E%3C/svg%3E">
  <link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='7' fill='%23060f1c'/%3E%3Crect x='9' y='14' width='14' height='13' rx='2' fill='%233db8f5'/%3E%3Crect x='7' y='10' width='18' height='5' rx='2' fill='%233db8f5'/%3E%3Cpath d='M13 7.5 L13 10 M16 6.5 L16 10 M19 7.5 L19 10' stroke='%233db8f5' stroke-width='1.8' stroke-linecap='round'/%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700;1,9..144,400;1,9..144,500&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#060f1c; --bg2:#091625; --surface:#0c1e35; --surface2:#102540;
      --glass:rgba(255,255,255,0.045); --border:rgba(255,255,255,0.08); --border2:rgba(255,255,255,0.13);
      --text:#ddeeff; --muted:rgba(221,238,255,0.5); --dim:rgba(221,238,255,0.28);
      --accent:#3db8f5; --accent2:#ffbe5c; --green:#5ecb74; --red:#f07070;
      --clear-c:#9fd49f; --clear-bg:rgba(159,212,159,.12); --clear-b:rgba(159,212,159,.2);
      --blue-c:#6eb8f7;  --blue-bg:rgba(110,184,247,.12);  --blue-b:rgba(110,184,247,.2);
      --glass-c:#72d4cc; --glass-bg:rgba(114,212,204,.12); --glass-b:rgba(114,212,204,.2);
      --black-c:#99b0c2; --black-bg:rgba(153,176,194,.1);  --black-b:rgba(153,176,194,.18);
      --food-c:#ffbe5c;  --food-bg:rgba(255,190,92,.12);   --food-b:rgba(255,190,92,.2);
      --r:16px; --rsm:10px; --sidebar:320px;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{height:100%}
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100%;-webkit-font-smoothing:antialiased;overscroll-behavior:none}

    #bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
    .blob{position:absolute;border-radius:50%;filter:blur(80px);opacity:.55}
    .blob-1{width:600px;height:600px;background:radial-gradient(circle,rgba(15,60,140,.5) 0%,transparent 70%);bottom:-150px;left:-100px}
    .blob-2{width:400px;height:400px;background:radial-gradient(circle,rgba(5,100,80,.3) 0%,transparent 70%);top:80px;right:-80px}
    .blob-3{width:350px;height:350px;background:radial-gradient(circle,rgba(61,184,245,.07) 0%,transparent 70%);top:50%;left:50%;transform:translate(-50%,-50%)}

    /* ‚îÄ‚îÄ MOBILE LAYOUT ‚îÄ‚îÄ */
    #app{position:relative;z-index:1;max-width:480px;margin:0 auto;min-height:100vh;padding-bottom:80px;display:flex;flex-direction:column}
    .header{padding:20px 20px 0;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:9px}
    .brand-mark{width:36px;height:36px;background:linear-gradient(135deg,#0e2a52 0%,#071830 100%);border:1px solid rgba(61,184,245,.25);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0}
    .brand-name{font-family:'Fraunces',serif;font-size:16.5px;font-weight:500;line-height:1.1;letter-spacing:-.01em}
    .brand-name em{color:var(--accent);font-style:italic}
    .brand-sub{font-size:10px;color:var(--dim);font-weight:400;letter-spacing:.02em}
    .icon-btn{width:34px;height:34px;border-radius:50%;background:var(--glass);border:1px solid var(--border);color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
    .icon-btn:hover{background:rgba(255,255,255,.08);color:var(--text)}
    .icon-btn svg{width:15px;height:15px}
    .desktop-nav{display:none}
    .page{display:none}
    .page.active{display:block}

    /* Search page */
    #page-search{padding:0 20px}
    .saved-section{margin-bottom:4px;animation:fadeUp .3s both}
    .saved-label{font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--dim);margin-bottom:8px;padding-top:20px;display:block}
    .saved-list{display:flex;flex-direction:column;gap:6px;margin-bottom:16px}
    .saved-card{display:flex;align-items:center;gap:10px;padding:11px 13px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--rsm);cursor:pointer;transition:background .12s}
    .saved-card:hover{background:var(--surface2)}
    .saved-card-icon{font-size:16px;flex-shrink:0}
    .saved-card-body{flex:1;min-width:0}
    .saved-card-addr{font-size:12.5px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .saved-card-meta{font-size:11px;color:var(--muted);margin-top:1px}
    .saved-card-badge{font-size:10px;font-weight:700;padding:2px 7px;border-radius:100px;background:rgba(61,184,245,.1);color:var(--accent);border:1px solid rgba(61,184,245,.2);white-space:nowrap;flex-shrink:0}
    .saved-card-del{width:22px;height:22px;border-radius:50%;background:rgba(240,112,112,.1);border:1px solid rgba(240,112,112,.2);color:#f4a0a0;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:13px;line-height:1;transition:background .15s}
    .saved-card-del:hover{background:rgba(240,112,112,.22)}
    .search-hero{padding:22px 0 18px;animation:fadeUp .4s .05s both}
    .search-hero-title{font-family:'Fraunces',serif;font-size:28px;font-weight:500;line-height:1.15;margin-bottom:8px;letter-spacing:-.02em}
    .search-hero-title em{color:var(--accent);font-style:italic}
    .search-hero-sub{font-size:13.5px;color:var(--muted);line-height:1.6}
    .search-row{display:flex;gap:8px;margin-bottom:10px;animation:fadeUp .4s .12s both}
    .search-wrap{position:relative;flex:1}
    .search-icon{position:absolute;left:13px;top:50%;transform:translateY(-50%);color:var(--dim);pointer-events:none}
    .search-icon svg{width:15px;height:15px;display:block}
    .search-input{width:100%;padding:13px 13px 13px 38px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--rsm);color:var(--text);font-size:15px;font-family:'DM Sans',sans-serif;transition:border-color .2s,box-shadow .2s;-webkit-appearance:none}
    .search-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(61,184,245,.12)}
    .search-input::placeholder{color:var(--dim)}
    .btn-search{padding:13px 18px;background:var(--accent);color:#060f1c;border:none;border-radius:var(--rsm);font-size:14px;font-weight:700;font-family:'DM Sans',sans-serif;cursor:pointer;white-space:nowrap;transition:opacity .15s,transform .1s;display:flex;align-items:center;gap:6px}
    .btn-search:hover{opacity:.88}.btn-search:active{transform:scale(.97)}.btn-search:disabled{opacity:.5;cursor:default;transform:none}
    .btn-search svg{width:15px;height:15px}
    .gps-row{display:flex;align-items:center;gap:8px;margin-bottom:16px;animation:fadeUp .4s .18s both}
    .gps-divider{flex:1;height:1px;background:var(--border)}
    .btn-gps{display:flex;align-items:center;gap:6px;padding:7px 14px;background:rgba(61,184,245,.08);border:1px solid rgba(61,184,245,.22);border-radius:100px;color:var(--accent);font-size:12px;font-weight:500;font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .2s}
    .btn-gps:hover{background:rgba(61,184,245,.14)}.btn-gps:disabled{opacity:.5;cursor:default}
    .btn-gps svg{width:12px;height:12px}
    .results-box{background:var(--surface);border:1px solid var(--border2);border-radius:var(--r);overflow:hidden;margin-bottom:12px;animation:fadeUp .25s both}
    .results-header{padding:10px 14px;font-size:10.5px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);border-bottom:1px solid var(--border)}
    .results-refine{padding:9px 14px 7px;font-size:11.5px;color:var(--muted);border-bottom:1px solid var(--border);font-style:italic}
    .result-item{display:flex;align-items:center;padding:12px 14px;gap:10px;cursor:pointer;border-bottom:1px solid var(--border);transition:background .12s}
    .result-item:last-child{border-bottom:none}.result-item:hover{background:rgba(61,184,245,.06)}.result-item:active{background:rgba(61,184,245,.1)}
    .result-icon{width:28px;height:28px;flex-shrink:0;background:var(--surface2);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px}
    .result-text{flex:1;min-width:0}
    .result-addr{font-size:13px;font-weight:500;display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .result-pc{font-size:11px;color:var(--muted);margin-top:1px;display:block}
    .result-chevron{color:var(--dim);flex-shrink:0}.result-chevron svg{width:14px;height:14px;display:block}
    .msg{display:flex;align-items:flex-start;gap:9px;padding:12px 14px;border-radius:var(--rsm);font-size:12.5px;line-height:1.55;margin-bottom:10px;animation:fadeUp .2s both}
    .msg-icon{font-size:15px;flex-shrink:0;margin-top:1px}
    .msg.error{background:rgba(240,112,112,.1);border:1px solid rgba(240,112,112,.2);color:#f4a0a0}
    .msg.info{background:rgba(61,184,245,.08);border:1px solid rgba(61,184,245,.2);color:var(--accent)}
    .msg.warn{background:rgba(255,190,92,.08);border:1px solid rgba(255,190,92,.2);color:var(--accent2)}
    .msg.success{background:rgba(94,203,116,.08);border:1px solid rgba(94,203,116,.25);color:var(--green)}
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(6,15,28,.25);border-top-color:#060f1c;border-radius:50%;animation:spin .7s linear infinite}
    .spinner-blue{border-color:rgba(61,184,245,.25);border-top-color:var(--accent)}

    /* Home page */
    #page-home{padding:0}
    .addr-strip{display:flex;align-items:center;gap:8px;padding:14px 20px 0}
    .addr-strip svg{width:13px;height:13px;color:var(--accent);flex-shrink:0}
    .addr-strip-text{flex:1;font-size:12.5px;font-weight:500;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .addr-change{font-size:11.5px;color:var(--accent);cursor:pointer;white-space:nowrap;text-decoration:underline;opacity:.8}
    .stale-bar{display:flex;align-items:center;gap:8px;margin:8px 20px 0;padding:8px 12px;background:rgba(255,190,92,.07);border:1px solid rgba(255,190,92,.18);border-radius:var(--rsm);font-size:11.5px;color:var(--accent2)}
    .stale-bar svg{width:13px;height:13px;flex-shrink:0}.stale-bar-text{flex:1}
    .btn-refresh{font-size:11px;font-weight:700;color:var(--accent2);background:none;border:none;cursor:pointer;text-decoration:underline;font-family:'DM Sans',sans-serif;padding:0}
    .hero{padding:10px 20px 0}
    .hero-card{background:linear-gradient(145deg,var(--surface) 0%,var(--surface2) 100%);border:1px solid var(--border2);border-radius:var(--r);padding:22px 20px 20px;position:relative;overflow:hidden}
    .hero-card::before{content:'';position:absolute;inset:0;pointer-events:none;background:radial-gradient(ellipse at 90% 10%,rgba(61,184,245,.07) 0%,transparent 60%)}
    .hero-eyebrow{font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--accent);margin-bottom:7px}
    .hero-night{font-family:'Fraunces',serif;font-size:34px;line-height:1.05;font-weight:500;letter-spacing:-.02em;margin-bottom:5px}
    .hero-meta{font-size:12.5px;color:var(--muted);margin-bottom:14px;line-height:1.5}
    .countdown{display:inline-flex;align-items:center;gap:6px;padding:6px 13px;border-radius:100px;font-size:12.5px;font-weight:600;margin-bottom:16px;background:rgba(61,184,245,.1);border:1px solid rgba(61,184,245,.25);color:var(--accent)}
    .countdown.tonight{background:rgba(94,203,116,.12);border-color:rgba(94,203,116,.3);color:var(--green)}
    .countdown svg{width:13px;height:13px}
    .bags{display:grid;grid-template-columns:1fr 1fr;gap:7px}
    .bag-chip{display:flex;align-items:center;gap:8px;padding:10px 11px;border-radius:var(--rsm);border:1px solid transparent;font-size:12px;font-weight:500}
    .bag-chip.full{grid-column:span 2}
    .bag-chip.clear{background:var(--clear-bg);border-color:var(--clear-b);color:var(--clear-c)}
    .bag-chip.blue{background:var(--blue-bg);border-color:var(--blue-b);color:var(--blue-c)}
    .bag-chip.glass{background:var(--glass-bg);border-color:var(--glass-b);color:var(--glass-c)}
    .bag-chip.black{background:var(--black-bg);border-color:var(--black-b);color:var(--black-c)}
    .bag-chip.food{background:var(--food-bg);border-color:var(--food-b);color:var(--food-c)}
    .chip-emo{font-size:18px;flex-shrink:0}.chip-info{min-width:0}
    .chip-name{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .chip-sub{display:block;font-size:10.5px;opacity:.6;font-weight:400;margin-top:1px}
    .action-bar{display:flex;gap:7px;margin:10px 20px 0}
    .action-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:9px 8px;border-radius:var(--rsm);border:1px solid var(--border2);background:var(--glass);font-size:11.5px;font-weight:600;font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .15s;color:var(--muted)}
    .action-btn:hover{background:rgba(255,255,255,.07);color:var(--text)}
    .action-btn svg{width:14px;height:14px;flex-shrink:0}
    .action-btn.saved{color:var(--green);border-color:rgba(94,203,116,.3);background:rgba(94,203,116,.08)}
    .action-btn.notify-on{color:var(--accent2);border-color:rgba(255,190,92,.3);background:rgba(255,190,92,.08)}
    .install-banner{margin:10px 20px 0;display:flex;align-items:center;gap:10px;padding:11px 14px;background:rgba(61,184,245,.07);border:1px solid rgba(61,184,245,.18);border-radius:var(--rsm);cursor:pointer;transition:background .15s}
    .install-banner:hover{background:rgba(61,184,245,.12)}
    .install-banner-icon{font-size:18px;flex-shrink:0}.install-banner-body{flex:1}
    .install-banner-body strong{display:block;font-size:12.5px;color:var(--accent)}
    .install-banner-body span{font-size:11px;color:var(--muted)}
    .install-banner-arrow{color:var(--dim);font-size:18px}
    .section{padding:0 20px;margin-top:18px}
    .section-label{font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--dim);margin-bottom:10px}
    .cal-list{display:flex;flex-direction:column;gap:6px}
    .cal-row{display:flex;align-items:center;background:var(--glass);border:1px solid var(--border);border-radius:var(--rsm);padding:11px 13px;gap:11px}
    .cal-row.next{background:rgba(61,184,245,.06);border-color:rgba(61,184,245,.18)}
    .cal-date{min-width:48px}.cal-dow{font-size:12.5px;font-weight:600}.cal-dstr{font-size:10.5px;color:var(--muted);margin-top:1px}
    .cal-pills{display:flex;flex-wrap:wrap;gap:4px;flex:1}
    .pill{font-size:10px;padding:2.5px 7px;border-radius:100px;font-weight:600;white-space:nowrap}
    .pill.clear{background:var(--clear-bg);color:var(--clear-c)}.pill.blue{background:var(--blue-bg);color:var(--blue-c)}
    .pill.glass{background:var(--glass-bg);color:var(--glass-c)}.pill.black{background:var(--black-bg);color:var(--black-c)}
    .pill.food{background:var(--food-bg);color:var(--food-c)}.cal-badge{font-size:10px;color:var(--accent);font-weight:700;white-space:nowrap}
    .guide-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px}
    .guide-tile{background:var(--glass);border:1px solid var(--border);border-radius:var(--rsm);padding:13px 12px}
    .guide-tile.full{grid-column:span 2}.guide-emo{font-size:20px;display:block;margin-bottom:6px}
    .guide-ttl{font-size:12.5px;font-weight:600;margin-bottom:3px}.guide-desc{font-size:11px;color:var(--muted);line-height:1.55}

    /* Info page */
    #page-info{padding:20px 20px 0}
    .info-stack{display:flex;flex-direction:column;gap:9px;margin-top:12px}
    .info-card{background:var(--glass);border:1px solid var(--border);border-radius:var(--rsm);padding:15px}
    .info-card h3{font-size:13px;font-weight:600;color:var(--accent);margin-bottom:7px}
    .info-card p{font-size:12px;color:var(--muted);line-height:1.65}
    .info-card a{color:var(--accent)}.info-card strong{color:var(--text)}

    /* Bottom nav */
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;z-index:50;background:rgba(6,15,28,.94);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;padding:6px 0 max(6px,env(safe-area-inset-bottom))}
    .nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 4px;background:none;border:none;color:var(--dim);font-family:'DM Sans',sans-serif;font-size:10px;font-weight:500;cursor:pointer;transition:color .15s}
    .nav-btn svg{width:20px;height:20px}.nav-btn.active{color:var(--accent)}

    /* Toast */
    .toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);background:#1a3a5c;border:1px solid rgba(61,184,245,.3);color:var(--text);padding:10px 18px;border-radius:100px;font-size:12.5px;font-weight:500;white-space:nowrap;z-index:300;opacity:0;transition:opacity .2s,transform .2s;pointer-events:none}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    /* ‚ïê‚ïê INSTALL ONBOARDING MODAL ‚ïê‚ïê */
    .onboard-overlay{position:fixed;inset:0;z-index:500;background:rgba(4,10,20,.85);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);display:flex;align-items:flex-end;justify-content:center;animation:fadeIn .3s both}
    .onboard-sheet{background:linear-gradient(170deg,#0d1f38 0%,#071425 100%);border:1px solid var(--border2);border-top:1px solid rgba(61,184,245,.2);border-radius:28px 28px 0 0;width:100%;max-width:480px;padding:0 0 max(28px,env(safe-area-inset-bottom));animation:slideUp .35s cubic-bezier(.22,1,.36,1) both;max-height:90vh;overflow-y:auto}
    .onboard-handle{width:40px;height:4px;background:rgba(255,255,255,.15);border-radius:2px;margin:14px auto 0}
    .onboard-head{padding:20px 24px 0;display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .onboard-title{font-family:'Fraunces',serif;font-size:24px;font-weight:500;letter-spacing:-.02em;line-height:1.2}
    .onboard-title em{color:var(--accent);font-style:italic}
    .onboard-close{width:32px;height:32px;border-radius:50%;background:var(--glass);border:1px solid var(--border);color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;font-size:18px;line-height:1}
    .onboard-sub{padding:8px 24px 0;font-size:13px;color:var(--muted);line-height:1.55}
    .onboard-steps{padding:16px 24px 0;display:flex;flex-direction:column;gap:0}
    .onboard-step{display:flex;gap:14px;padding:14px 0;border-bottom:1px solid var(--border)}
    .onboard-step:last-child{border-bottom:none}
    .step-num{width:28px;height:28px;border-radius:50%;background:rgba(61,184,245,.12);border:1px solid rgba(61,184,245,.25);color:var(--accent);font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px}
    .step-body{flex:1}.step-title{font-size:13.5px;font-weight:600;margin-bottom:3px}
    .step-desc{font-size:12px;color:var(--muted);line-height:1.55}
    .step-visual{flex-shrink:0;width:50px;display:flex;align-items:center;justify-content:center}
    .step-icon-wrap{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
    .step-icon-wrap.c-blue{background:rgba(61,184,245,.1);border:1px solid rgba(61,184,245,.2)}
    .step-icon-wrap.c-green{background:rgba(94,203,116,.1);border:1px solid rgba(94,203,116,.2)}
    .step-icon-wrap.c-amber{background:rgba(255,190,92,.1);border:1px solid rgba(255,190,92,.2)}
    .onboard-cta{padding:18px 24px 0;display:flex;flex-direction:column;gap:8px}
    .btn-onboard-primary{width:100%;padding:14px;background:var(--accent);color:#060f1c;border:none;border-radius:var(--r);font-size:14.5px;font-weight:700;font-family:'DM Sans',sans-serif;cursor:pointer;transition:opacity .15s}
    .btn-onboard-primary:hover{opacity:.88}
    .btn-onboard-dismiss{width:100%;padding:10px;background:none;border:none;color:var(--dim);font-size:12.5px;font-family:'DM Sans',sans-serif;cursor:pointer}
    .btn-onboard-dismiss:hover{color:var(--muted)}

    /* iOS share arrow */
    .ios-arrow-hint{display:none;position:fixed;bottom:max(28px,calc(env(safe-area-inset-bottom)+22px));left:50%;transform:translateX(-50%);z-index:600;text-align:center;pointer-events:none}
    .ios-arrow-hint.show{display:block}
    .ios-arrow-bubble{background:var(--accent2);color:#060f1c;font-size:12px;font-weight:700;padding:9px 18px;border-radius:100px;white-space:nowrap;animation:bob .9s ease-in-out infinite alternate;display:inline-block}
    .ios-arrow-bubble::after{content:'';display:block;width:0;height:0;border:8px solid transparent;border-top:8px solid var(--accent2);border-bottom:0;margin:-1px auto -9px;position:relative;top:8px}


    /* ‚îÄ‚îÄ AD SLOT ‚îÄ‚îÄ */
    .ad-slot{margin:0 20px;padding:12px;background:rgba(255,255,255,.025);border:1px dashed rgba(255,255,255,.1);border-radius:var(--rsm);text-align:center;min-height:100px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px}
    .ad-slot-label{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);font-weight:600}
    .ad-slot-inner{width:100%;max-width:320px;min-height:50px;background:rgba(255,255,255,.02);border-radius:6px;display:flex;align-items:center;justify-content:center}
    @media(min-width:900px){.ad-slot{margin:0 32px;min-height:120px}.ad-slot-inner{max-width:728px;min-height:90px}}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    @keyframes bob{from{transform:translateY(0)}to{transform:translateY(-7px)}}
    @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none!important}

    /* ‚ïê‚ïê DESKTOP LAYOUT ‚â•900px ‚ïê‚ïê */
    @media(min-width:900px){
      body{overflow:hidden}
      #app{max-width:100%;height:100vh;padding-bottom:0;display:grid;grid-template-columns:var(--sidebar) 1fr;grid-template-rows:60px 1fr;grid-template-areas:"topbar topbar" "sidebar main";overflow:hidden}

      /* Header becomes full-width top bar */
      .header{grid-area:topbar;padding:0 32px;height:60px;display:flex;align-items:center;border-bottom:1px solid var(--border);background:rgba(6,15,28,.75);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
      .header .icon-btn{display:none}
      .brand-name{font-size:17px}

      /* Desktop nav in header */
      .desktop-nav{display:flex;align-items:center;gap:4px;margin-left:auto}
      .desktop-nav-btn{display:flex;align-items:center;gap:6px;padding:7px 14px;border-radius:8px;background:none;border:none;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all .18s}
      .desktop-nav-btn:hover{background:var(--glass);color:var(--text)}
      .desktop-nav-btn.active{background:rgba(61,184,245,.1);color:var(--accent)}
      .desktop-nav-btn svg{width:15px;height:15px}

      /* Sidebar ‚Äî search always visible */
      #page-search{grid-area:sidebar;display:block!important;padding:24px 24px;border-right:1px solid var(--border);overflow-y:auto;height:100%}
      .search-hero{padding:0 0 20px}
      .search-hero-title{font-size:22px}

      /* Main content area */
      #page-home,#page-info{grid-area:main;overflow-y:auto;height:100%;display:none;padding-bottom:40px}
      #page-home.active,#page-info.active{display:block}

      /* Home adjustments for desktop */
      .addr-strip{padding:28px 32px 0}
      .stale-bar{margin:10px 32px 0}
      .hero{padding:12px 32px 0}
      .hero-card{padding:28px 28px 24px}
      .hero-night{font-size:42px}
      .action-bar{margin:12px 32px 0}
      .install-banner{margin:12px 32px 0}
      .section{padding:0 32px}
      .guide-grid{grid-template-columns:repeat(3,1fr)}
      .guide-tile.full{grid-column:span 3}

      /* Info adjustments */
      #page-info{padding:32px 32px 40px}
      .info-stack{padding:0!important;margin-top:0}

      /* Hide mobile nav, move toast */
      .bottom-nav{display:none}
      .toast{bottom:32px}

      /* Onboarding never on desktop */
      .onboard-overlay,.ios-arrow-hint{display:none!important}
    }

    @media(min-width:600px) and (max-width:899px){
      #app{max-width:600px}
    }
  </style>
</head>
<body>

<div id="bg" aria-hidden="true">
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>
  <div class="blob blob-3"></div>
</div>

<!-- ‚ïê‚ïê INSTALL ONBOARDING MODAL ‚ïê‚ïê -->
<div class="onboard-overlay hidden" id="onboard-overlay">
  <div class="onboard-sheet">
    <div class="onboard-handle"></div>
    <div class="onboard-head">
      <div class="onboard-title">Get the <em>app</em></div>
      <button class="onboard-close" id="onboard-close">√ó</button>
    </div>
    <p class="onboard-sub" id="onboard-sub"></p>
    <div class="onboard-steps" id="onboard-steps"></div>
    <div class="onboard-cta">
      <button class="btn-onboard-primary hidden" id="btn-onboard-install">üì≤ Install Now</button>
      <button class="btn-onboard-dismiss" id="btn-onboard-dismiss">Maybe later</button>
    </div>
  </div>
</div>

<!-- iOS animated share arrow -->
<div class="ios-arrow-hint" id="ios-arrow">
  <div class="ios-arrow-bubble">Tap the Share button ‚Üì</div>
</div>

<div id="app">

  <header class="header">
    <div class="brand">
      <div class="brand-mark">üóëÔ∏è</div>
      <div>
        <div class="brand-name">Bin Night <em>Guernsey</em></div>
        <div class="brand-sub">KERBSIDE COLLECTION</div>
      </div>
    </div>
    <nav class="desktop-nav" id="desktop-nav">
      <button class="desktop-nav-btn active" data-page="search">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>Search
      </button>
      <button class="desktop-nav-btn" data-page="home">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>My Night
      </button>
      <button class="desktop-nav-btn" data-page="info">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>Info
      </button>
    </nav>
    <button class="icon-btn" id="btn-change" aria-label="Search">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    </button>
  </header>

  <!-- SEARCH / SIDEBAR -->
  <div id="page-search" class="page active">
    <div id="saved-section" class="saved-section hidden">
      <span class="saved-label">Saved Addresses</span>
      <div class="saved-list" id="saved-list"></div>
    </div>
    <div class="search-hero">
      <h1 class="search-hero-title">What's out<br><em>tonight?</em></h1>
      <p class="search-hero-sub">Enter your address or postcode to see your exact collection schedule.</p>
    </div>
    <div class="search-row">
      <div class="search-wrap">
        <span class="search-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg></span>
        <input id="search-input" class="search-input" type="text" placeholder="e.g. GY1 1AA or Les Grav√©es" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      </div>
      <button class="btn-search" id="btn-search">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>Search
      </button>
    </div>
    <div class="gps-row">
      <div class="gps-divider"></div>
      <button class="btn-gps" id="btn-gps">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M12 2v3m0 14v3M2 12h3m14 0h3"/><circle cx="12" cy="12" r="8" opacity="0.3"/></svg>Use my location
      </button>
      <div class="gps-divider"></div>
    </div>
    <div id="search-feedback"></div>
  </div>

  <!-- HOME -->
  <div id="page-home" class="page">
    <div class="addr-strip">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
      <span class="addr-strip-text" id="addr-strip-text">‚Äî</span>
      <span class="addr-change" id="addr-change">Change</span>
    </div>
    <div class="stale-bar hidden" id="stale-bar">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      <span class="stale-bar-text" id="stale-bar-text"></span>
      <button class="btn-refresh" id="btn-refresh">Refresh ‚Üí</button>
    </div>
    <div class="hero">
      <div class="hero-card">
        <div class="hero-eyebrow" id="hero-eyebrow">NEXT COLLECTION</div>
        <div class="hero-night" id="hero-night">‚Äî</div>
        <div class="hero-meta" id="hero-meta"></div>
        <div class="countdown" id="countdown">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          <span id="countdown-txt">‚Äî</span>
        </div>
        <div class="bags" id="bags-grid"></div>
      </div>
    </div>
    <div class="action-bar">
      <button class="action-btn" id="btn-save">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        <span id="btn-save-txt">Save</span>
      </button>
      <button class="action-btn" id="btn-notify">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
        <span id="btn-notify-txt">Remind me</span>
      </button>
      <button class="action-btn" id="btn-share">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
        Share
      </button>
    </div>
    <div class="install-banner hidden" id="install-banner" role="button" tabindex="0">
      <span class="install-banner-icon">üì≤</span>
      <div class="install-banner-body"><strong>Add to Home Screen</strong><span id="install-sub">Get this as an app on your phone</span></div>
      <span class="install-banner-arrow">‚Ä∫</span>
    </div>
    <div class="section">
      <p class="section-label">Upcoming Collections</p>
      <div class="cal-list" id="cal-list"></div>
    </div>
    <!-- ‚ïê‚ïê AD SLOT ‚ïê‚ïê
         Replace the ad-slot-inner div content with your AdSense <ins> tag once approved.
         AdSense auto ads will also work if you just paste the AdSense <script> in <head>.
    -->
    <div class="section" id="ad-section">
      <div class="ad-slot">
        <span class="ad-slot-label">Advertisement</span>
        <div class="ad-slot-inner" id="ad-slot-inner">
          <!-- AdSense code goes here, e.g:
          <ins class="adsbygoogle"
               style="display:block"
               data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
               data-ad-slot="XXXXXXXXXX"
               data-ad-format="auto"
               data-full-width-responsive="true"></ins>
          <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
          -->
        </div>
      </div>
    </div>

    <div class="section" style="margin-bottom:8px">
      <p class="section-label">What goes in each bag?</p>
      <div class="guide-grid">
        <div class="guide-tile"><span class="guide-emo">üóÇÔ∏è</span><div class="guide-ttl" style="color:var(--clear-c)">Clear Bag</div><div class="guide-desc">Paper, cardboard, magazines, envelopes</div></div>
        <div class="guide-tile"><span class="guide-emo">‚ôªÔ∏è</span><div class="guide-ttl" style="color:var(--blue-c)">Blue Bag</div><div class="guide-desc">Plastics, tins, cans, cartons, foil</div></div>
        <div class="guide-tile"><span class="guide-emo">üç∂</span><div class="guide-ttl" style="color:var(--glass-c)">Glass Bag</div><div class="guide-desc">Clean bottles and jars</div></div>
        <div class="guide-tile"><span class="guide-emo">ü•ï</span><div class="guide-ttl" style="color:var(--food-c)">Food Caddy</div><div class="guide-desc">All food scraps ‚Äî every week</div></div>
        <div class="guide-tile full"><span class="guide-emo">üñ§</span><div class="guide-ttl" style="color:var(--black-c)">Black Bag</div><div class="guide-desc">General refuse ‚Äî needs a pay-as-you-throw sticker. Orange 50L, green 90L. Fortnightly.</div></div>
      </div>
    </div>
  </div>

  <!-- INFO -->
  <div id="page-info" class="page">
    <div style="padding-top:22px"><p class="section-label" style="padding:0 20px 10px">About &amp; Help</p></div>
    <div class="info-stack" style="padding:0 20px">
      <div class="info-card"><h3>How it works</h3><p>Enter your address or postcode ‚Äî we look it up live from the official Guernsey Waste calendar. Save up to 3 addresses to switch between them instantly.</p></div>
      <div class="info-card"><h3>Reminders</h3><p>Tap <strong>Remind me</strong> on your schedule and we'll send a browser notification at <strong>8pm the evening before</strong> your collection. Works best when the app is installed to your home screen.</p></div>
      <div class="info-card"><h3>Set out times</h3><p>Put bags out from <strong>8pm</strong>, no later than <strong>10:30pm</strong> the evening before collection.</p></div>
      <div class="info-card"><h3>The bag rotation</h3><p><strong>Clear bag week</strong> ‚Äî St Peter Port &amp; St Sampson: clear + food + glass. All other parishes: clear + food + black.<br><br><strong>Blue bag week</strong> ‚Äî St Peter Port &amp; St Sampson: blue + food + black. All other parishes: blue + food + glass.</p></div>
      <div class="info-card"><h3>Pay as you throw</h3><p>Every black bag needs a prepaid sticker. <strong>Orange</strong> for 50L, <strong>Green</strong> for 90L. Available from supermarkets and Guernsey Post.</p></div>
      <div class="info-card"><h3>Missed a collection?</h3><p>Contact your Parish Constables via <a href="https://www.gov.gg/parishes" target="_blank" rel="noopener">gov.gg/parishes ‚Üó</a></p></div>
      <div class="info-card"><h3>Data source</h3><p>Schedules come live from <a href="https://guernsey.isl-fusion.com" target="_blank" rel="noopener">guernsey.isl-fusion.com ‚Üó</a> ‚Äî the official Guernsey Waste calendar.</p></div>
      <div class="info-card"><h3>Legal</h3><p>This site uses cookies and may display personalised ads. <a href="privacy.html" target="_blank" rel="noopener">Privacy Policy ‚Üó</a> &nbsp;¬∑&nbsp; <a href="privacy.html#cookies" target="_blank" rel="noopener">Cookie Policy ‚Üó</a><br><br>Bin Night Guernsey is an independent tool, not affiliated with the States of Guernsey or ISL Fusion.</p></div>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>
<div style="position:fixed;bottom:0;left:0;right:0;z-index:49;pointer-events:none;display:flex;justify-content:center;padding-bottom:max(4px,env(safe-area-inset-bottom))"><a href="privacy.html" target="_blank" rel="noopener" style="pointer-events:all;font-size:9px;color:rgba(221,238,255,.2);text-decoration:none;letter-spacing:.5px;padding:2px 8px" aria-label="Privacy Policy">Privacy Policy</a></div>

<nav class="bottom-nav">
  <button class="nav-btn active" data-page="search" id="nav-search">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>Search
  </button>
  <button class="nav-btn" data-page="home" id="nav-home">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>My Night
  </button>
  <button class="nav-btn" data-page="info" id="nav-info">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>Info
  </button>
</nav>

<script>
const FUSION  = 'https://guernsey.isl-fusion.com';
const PROXY_A = 'https://fusion-proxy.marcustedde.workers.dev/?url=';
const PROXY_B = 'https://corsproxy.io/?url=';
const MAX_SAVED=3, STALE_DAYS=7;

let STATE={address:null,viewHref:null,dayName:null,night:null,collections:[],savedAt:null};
let SAVED=[], notifTimers=[];

const isIOS=/iphone|ipad|ipod/i.test(navigator.userAgent);
const isAndroid=/android/i.test(navigator.userAgent);
const isMobile=isIOS||isAndroid||(window.innerWidth<900);
const isStandalone=window.matchMedia('(display-mode: standalone)').matches||navigator.standalone;
const isDesktop=window.innerWidth>=900;

const ITEM_MAP=[
  {match:/food/i,          k:'food', label:'Food Caddy',icon:'ü•ï',sub:'food waste'},
  {match:/cans|plastic|carton/i,k:'blue',label:'Blue Bag',icon:'‚ôªÔ∏è',sub:'plastics, tins & cans'},
  {match:/paper|cardboard/i,k:'clear',label:'Clear Bag',icon:'üóÇÔ∏è',sub:'paper & cardboard'},
  {match:/glass/i,         k:'glass',label:'Glass Bag', icon:'üç∂',sub:'bottles & jars'},
  {match:/residual|general|refuse|waste/i,k:'black',label:'Black Bag',icon:'üñ§',sub:'general refuse'},
];
function mapItem(t){for(const m of ITEM_MAP)if(m.match.test(t))return{k:m.k,label:m.label,icon:m.icon,sub:m.sub};return{k:'black',label:t.trim(),icon:'üóëÔ∏è',sub:''};}

const MONTH_IDX={january:0,february:1,march:2,april:3,may:4,june:5,july:6,august:7,september:8,october:9,november:10,december:11};
const DOW_NAME=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const DOW_ISO=[7,1,2,3,4,5,6];
const MS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const DS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

function parseDate(s){
  const iso=s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(iso)return new Date(+iso[1],+iso[2]-1,+iso[3]);
  const lg=s.match(/(\d{1,2})(?:st|nd|rd|th)?\s+([A-Za-z]+)(?:\s+(\d{4}))?/);
  if(lg){const mon=MONTH_IDX[lg[2].toLowerCase()];if(mon===undefined)return null;const yr=lg[3]?+lg[3]:new Date().getFullYear();const d=new Date(yr,mon,+lg[1]);if(!lg[3]&&d<new Date())d.setFullYear(d.getFullYear()+1);return d;}
  return null;
}
function daysUntil(d){const n=new Date();n.setHours(0,0,0,0);return Math.round((d-n)/86400000);}
function timeAgo(ts){const d=Math.round((Date.now()-ts)/86400000);return d===0?'today':d===1?'yesterday':d+' days ago';}

function parseFusionPage(html){
  const evs=[];
  const sec=html.match(/<div[^>]+id="nextCollectionSection"[^>]*>([\s\S]*?)(?=<div\s+class="row)/i);
  if(sec){
    for(const chunk of sec[1].split(/<h5>/i).slice(1)){
      const dm=chunk.match(/<u>([^<]+)<\/u>/i);if(!dm)continue;
      const dateOnly=dm[1].trim().replace(/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\s+/i,'');
      const date=parseDate(dateOnly);if(!date)continue;
      const dow=date.getDay();
      const items=[...chunk.matchAll(/<li[^>]*>[\s\S]*?<img[^>]*>[\s\S]*?([^<]+)/gi)].map(m=>mapItem(m[1].trim())).filter(Boolean);
      if(items.length)evs.push({date,dayName:DOW_NAME[dow],night:DOW_ISO[dow],items});
    }
  }
  if(!evs.length){
    const cr=/<td[^>]*>[\s\S]*?<abbr\s+title="([^"]+)"[\s\S]*?<\/td>/gi;let cm;
    while((cm=cr.exec(html))!==null){
      const cell=cm[0];if(!cell.includes('<img'))continue;
      const date=parseDate(cm[1].replace(/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\s+/i,''));if(!date)continue;
      const items=[...cell.matchAll(/alt="([^"]+)"/gi)].map(m=>mapItem(m[1])).filter(Boolean);
      if(items.length)evs.push({date,dayName:DOW_NAME[date.getDay()],night:DOW_ISO[date.getDay()],items});
    }
  }
  evs.sort((a,b)=>a.date-b.date);
  const seen=new Set();
  return evs.filter(e=>{const k=e.date.toDateString();if(seen.has(k))return false;seen.add(k);return true;});
}

async function proxyFetch(url,wj){
  try{const r=await fetch(PROXY_A+encodeURIComponent(url));if(r.ok)return wj?r.json():r.text();}catch(_){}
  try{const r=await fetch(PROXY_B+encodeURIComponent(url),{headers:{'X-Requested-With':'XMLHttpRequest'}});if(r.ok)return wj?r.json():r.text();}catch(_){}
  throw new Error('Unable to reach the Guernsey Waste calendar. Please check your connection.');
}
async function searchFusion(q){return proxyFetch(`${FUSION}/address/${encodeURIComponent(q.toLowerCase())}`,true);}
async function fetchSchedule(href){const h=await proxyFetch(`${FUSION}${href}`,false);return parseFusionPage(typeof h==='string'?h:(h?.contents||JSON.stringify(h)));}

function ser(s){return{...s,collections:s.collections.map(e=>({...e,date:e.date.toISOString()}))};}
function des(r){return{...r,collections:(r.collections||[]).map(e=>({...e,date:new Date(e.date)}))};}
function saveState(){localStorage.setItem('bn_state',JSON.stringify(ser(STATE)));}
function loadState(){try{const s=localStorage.getItem('bn_state');if(s)STATE=des(JSON.parse(s));}catch(_){}}
function saveSaved(){localStorage.setItem('bn_saved',JSON.stringify(SAVED));}
function loadSaved(){try{const s=localStorage.getItem('bn_saved');if(s)SAVED=JSON.parse(s);}catch(_){}}
function findSaved(href){return SAVED.find(s=>s.viewHref===href);}
function isSaved(href){return!!findSaved(href);}

let toastTimer=null;
function showToast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');clearTimeout(toastTimer);toastTimer=setTimeout(()=>el.classList.remove('show'),2800);}

function clearNotifTimers(){notifTimers.forEach(clearTimeout);notifTimers=[];}
function scheduleNotifications(cols,label){
  clearNotifTimers();if(Notification.permission!=='granted'||!cols?.length)return;
  const now=new Date();now.setHours(0,0,0,0);
  cols.filter(e=>e.date>=now).slice(0,4).forEach(ev=>{
    const t=new Date(ev.date);t.setDate(t.getDate()-1);t.setHours(20,0,0,0);
    const ms=t-new Date();if(ms<=0)return;
    const id=setTimeout(()=>{try{new Notification('üóëÔ∏è Bin Night Tonight!',{body:`${label}: put out ${ev.items.map(i=>i.label).join(', ')}. Remember 8pm‚Äì10:30pm.`,tag:'bin-'+ev.date.toDateString(),renotify:false});}catch(e){}},ms);
    notifTimers.push(id);
  });
}
async function requestNotifications(){
  if(!('Notification' in window)){showToast('Notifications not supported');return false;}
  if(Notification.permission==='granted')return true;
  if(Notification.permission==='denied'){showToast('Notifications blocked ‚Äî enable in browser settings');return false;}
  return(await Notification.requestPermission())==='granted';
}
function notifEnabled(){const s=findSaved(STATE.viewHref);return s?.notifyEnabled&&Notification.permission==='granted';}

async function doShare(){
  const url=window.location.href.split('?')[0]+'?view='+encodeURIComponent(STATE.viewHref);
  try{if(navigator.share)await navigator.share({title:'Bin Night Guernsey',text:'Check your bin collection schedule',url});else{await navigator.clipboard.writeText(url);showToast('üìã Link copied to clipboard!');}}
  catch(_){try{await navigator.clipboard.writeText(url);showToast('üìã Link copied!');}catch(_){}}
}

function saveCurrentAddress(){
  if(!STATE.viewHref||isSaved(STATE.viewHref))return;
  if(SAVED.length>=MAX_SAVED){showToast(`Already ${MAX_SAVED} saved ‚Äî remove one first`);return;}
  SAVED.push({id:Date.now(),address:STATE.address,viewHref:STATE.viewHref,dayName:STATE.dayName,night:STATE.night,notifyEnabled:false,savedAt:Date.now()});
  saveSaved();updateSaveBtn();renderSavedList();showToast('‚úÖ Address saved!');
}
function removeSaved(href){SAVED=SAVED.filter(s=>s.viewHref!==href);saveSaved();renderSavedList();if(STATE.viewHref===href)updateSaveBtn();}

function renderSavedList(){
  const sec=document.getElementById('saved-section'),list=document.getElementById('saved-list');
  if(!SAVED.length){sec.classList.add('hidden');return;}
  sec.classList.remove('hidden');list.innerHTML='';
  SAVED.forEach(entry=>{
    const div=document.createElement('div');div.className='saved-card';
    const short=entry.address.replace(/\.\s*GY\d.*$/,'').trim();
    div.innerHTML=`<span class="saved-card-icon">üìç</span><div class="saved-card-body"><div class="saved-card-addr">${short}</div><div class="saved-card-meta">${entry.dayName} nights${entry.notifyEnabled?' ¬∑ üîî':''}</div></div><span class="saved-card-badge">${entry.dayName}</span><button class="saved-card-del" title="Remove">√ó</button>`;
    div.addEventListener('click',e=>{if(!e.target.closest('.saved-card-del'))loadFromSaved(entry);});
    div.querySelector('.saved-card-del').addEventListener('click',e=>{e.stopPropagation();removeSaved(entry.viewHref);});
    list.appendChild(div);
  });
}

async function loadFromSaved(entry){
  showFeedback('<div class="msg info"><span class="msg-icon">‚è≥</span><span>Loading schedule‚Ä¶</span></div>');
  try{
    const cols=await fetchSchedule(entry.viewHref);
    if(!cols.length){showFeedback('<div class="msg error"><span class="msg-icon">‚ö†Ô∏è</span><span>Couldn\'t load that schedule.</span></div>');return;}
    STATE={address:entry.address,viewHref:entry.viewHref,dayName:cols[0].dayName,night:cols[0].night,collections:cols,savedAt:Date.now()};
    saveState();const saved=findSaved(entry.viewHref);if(saved){saved.dayName=STATE.dayName;saved.night=STATE.night;saveSaved();}
    clearFeedback();renderHome();if(notifEnabled())scheduleNotifications(cols,entry.address.split(',')[0]);
  }catch(err){showFeedback(`<div class="msg error"><span class="msg-icon">üåê</span><span>${err.message}</span></div>`);}
}

function updateSaveBtn(){
  const btn=document.getElementById('btn-save'),txt=document.getElementById('btn-save-txt'),saved=isSaved(STATE.viewHref);
  btn.className='action-btn'+(saved?' saved':'');txt.textContent=saved?'Saved ‚úì':'Save';btn.style.cursor=saved?'default':'';
}
function updateNotifyBtn(){
  const btn=document.getElementById('btn-notify'),txt=document.getElementById('btn-notify-txt'),on=notifEnabled();
  btn.className='action-btn'+(on?' notify-on':'');txt.textContent=on?'Reminders on üîî':'Remind me';
}
function updateStaleBar(){
  const bar=document.getElementById('stale-bar'),txt=document.getElementById('stale-bar-text');
  if(!STATE.savedAt){bar.classList.add('hidden');return;}
  const age=Math.round((Date.now()-STATE.savedAt)/86400000);
  if(age>=STALE_DAYS){txt.textContent=`Schedule fetched ${timeAgo(STATE.savedAt)} ‚Äî may be outdated`;bar.classList.remove('hidden');}
  else bar.classList.add('hidden');
}

function renderHome(){
  const{address,collections}=STATE;if(!collections?.length)return;
  const now=new Date();now.setHours(0,0,0,0);
  const upcoming=collections.filter(e=>e.date>=now);if(!upcoming.length)return;
  const next=upcoming[0],days=daysUntil(next.date);

  document.getElementById('addr-strip-text').textContent=address||'‚Äî';
  document.getElementById('hero-eyebrow').textContent=days===0?"TONIGHT'S SET OUT":days===1?'TOMORROW NIGHT':'NEXT COLLECTION';
  document.getElementById('hero-night').textContent=next.dayName+' Night';
  document.getElementById('hero-meta').textContent='Put bags out 8pm ‚Äì 10:30pm the evening before';
  const cd=document.getElementById('countdown');
  document.getElementById('countdown-txt').textContent=days===0?'üéâ Tonight ‚Äî put bags out now!':days===1?'Tomorrow night':`In ${days} days`;
  cd.className='countdown'+(days===0?' tonight':'');

  const grid=document.getElementById('bags-grid');grid.innerHTML='';
  next.items.forEach(b=>{const el=document.createElement('div');el.className='bag-chip '+b.k;el.innerHTML=`<span class="chip-emo">${b.icon}</span><span class="chip-info"><span class="chip-name">${b.label}</span><span class="chip-sub">${b.sub}</span></span>`;grid.appendChild(el);});

  const calList=document.getElementById('cal-list');calList.innerHTML='';
  upcoming.slice(0,8).forEach((ev,i)=>{
    const row=document.createElement('div');row.className='cal-row'+(i===0?' next':'');
    const pills=ev.items.map(b=>`<span class="pill ${b.k}">${b.icon} ${b.label}</span>`).join('');
    const badge=i===0?`<span class="cal-badge">${days===0?'Tonight':'Next ‚Üí'}</span>`:'';
    row.innerHTML=`<div class="cal-date"><div class="cal-dow">${DS[ev.date.getDay()]}</div><div class="cal-dstr">${ev.date.getDate()} ${MS[ev.date.getMonth()]}</div></div><div class="cal-pills">${pills}</div>${badge}`;
    calList.appendChild(row);
  });
  updateSaveBtn();updateNotifyBtn();updateStaleBar();
  showPage('home');setActiveNav('home');
}

function showFeedback(h){document.getElementById('search-feedback').innerHTML=h;}
function clearFeedback(){document.getElementById('search-feedback').innerHTML='';}
function setBtnLoading(on){const btn=document.getElementById('btn-search');btn.disabled=on;btn.innerHTML=on?'<span class="spinner"></span>':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg> Search';}

async function doSearch(query){
  if(!query.trim())return;setBtnLoading(true);clearFeedback();
  try{
    const data=await searchFusion(query);
    const raw=data?.html||data?.contents||(typeof data==='string'?data:'');
    setBtnLoading(false);
    const links=[];const re=/href="(\/view\/([^"\/]+)\/)"[^>]*>\s*([^<]+?)\s*<\/a>/gi;let m;
    while((m=re.exec(raw))!==null){const t=m[3].trim();const pc=(t.match(/\b(GY\d{1,2}\s+\d[A-Z]{2})\b/i)||[])[1];links.push({href:m[1],address:t,postcode:pc?pc.toUpperCase():null});}
    if(!links.length){showFeedback(`<div class="msg error"><span class="msg-icon">‚ö†Ô∏è</span><span>No addresses found for <strong>"${query}"</strong>. Try your postcode (e.g. GY1 1AA) or road name.</span></div>`);return;}
    let html='<div class="results-box">';
    if(raw.includes('too many results'))html+='<div class="results-refine">Showing first results ‚Äî add your house number to narrow down</div>';
    html+='<div class="results-header">Select your address</div>';
    links.slice(0,30).forEach(a=>{const disp=a.address.replace(/\.\s*GY\d[^,]*$/,'').trim();html+=`<div class="result-item" data-href="${a.href}" data-address="${encodeURIComponent(a.address)}"><span class="result-icon">üè†</span><span class="result-text"><span class="result-addr">${disp}</span><span class="result-pc">${a.postcode||''}</span></span><span class="result-chevron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg></span></div>`;});
    html+='</div>';showFeedback(html);
    document.querySelectorAll('.result-item').forEach(el=>el.addEventListener('click',()=>selectAddress(el)));
  }catch(err){setBtnLoading(false);showFeedback(`<div class="msg error"><span class="msg-icon">üåê</span><span>${err.message}</span></div>`);}
}

async function selectAddress(el){
  const href=el.dataset.href,address=decodeURIComponent(el.dataset.address);
  el.innerHTML=`<span class="result-icon">‚è≥</span><span class="result-text"><span class="result-addr">Loading your schedule‚Ä¶</span></span>`;
  document.querySelectorAll('.result-item').forEach(e=>e.style.pointerEvents='none');
  try{
    const cols=await fetchSchedule(href);
    if(!cols.length){document.querySelectorAll('.result-item').forEach(e=>e.style.pointerEvents='');showFeedback(`<div class="msg warn"><span class="msg-icon">‚ö†Ô∏è</span><span>Couldn't load the schedule. Try a neighbour or visit <a href="https://guernsey.isl-fusion.com" target="_blank" rel="noopener" style="color:var(--accent2)">guernsey.isl-fusion.com ‚Üó</a></span></div>`);return;}
    STATE={address,viewHref:href,dayName:cols[0].dayName,night:cols[0].night,collections:cols,savedAt:Date.now()};
    saveState();renderHome();
    const saved=findSaved(href);if(saved?.notifyEnabled&&Notification.permission==='granted')scheduleNotifications(cols,address.split(',')[0]);
  }catch(err){document.querySelectorAll('.result-item').forEach(e=>e.style.pointerEvents='');showFeedback(`<div class="msg error"><span class="msg-icon">üåê</span><span>${err.message}</span></div>`);}
}

async function doGPS(){
  const btn=document.getElementById('btn-gps');btn.disabled=true;btn.innerHTML='<span class="spinner spinner-blue"></span> Detecting‚Ä¶';clearFeedback();
  try{
    if(!navigator.geolocation)throw new Error('Geolocation not supported');
    const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{timeout:10000,enableHighAccuracy:true}));
    const geo=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&format=json&zoom=16`,{headers:{'Accept-Language':'en','User-Agent':'BinNightGuernsey/1.0'}}).then(r=>r.json());
    if(!(geo.display_name||'').toLowerCase().includes('guernsey'))throw new Error("Your location doesn't appear to be in Guernsey.");
    const query=(geo.address||{}).postcode||geo.display_name.split(',').find(p=>/GY\d/i.test(p))?.trim()||'';
    btn.disabled=false;btn.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M12 2v3m0 14v3M2 12h3m14 0h3"/><circle cx="12" cy="12" r="8" opacity="0.3"/></svg> Use my location';
    document.getElementById('search-input').value=query;await doSearch(query);
  }catch(err){
    btn.disabled=false;btn.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M12 2v3m0 14v3M2 12h3m14 0h3"/><circle cx="12" cy="12" r="8" opacity="0.3"/></svg> Use my location';
    showFeedback(`<div class="msg error"><span class="msg-icon">üìç</span><span>${err.code===1?'Location permission denied. Please search your address instead.':err.message||'Location detection failed.'}</span></div>`);
  }
}

function showPage(name){
  if(isDesktop){
    // On desktop, search sidebar always stays active; only swap main panel
    document.getElementById('page-home').classList.remove('active');
    document.getElementById('page-info').classList.remove('active');
    if(name!=='search') document.getElementById('page-'+name).classList.add('active');
    return;
  }
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
}
function setActiveNav(name){
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('active',b.dataset.page===name));
  document.querySelectorAll('.desktop-nav-btn').forEach(b=>b.classList.toggle('active',b.dataset.page===name));
}

document.querySelectorAll('.nav-btn').forEach(btn=>btn.addEventListener('click',()=>{
  const p=btn.dataset.page;
  if(p==='home'&&!STATE.collections?.length){showPage('search');setActiveNav('search');return;}
  showPage(p);setActiveNav(p);if(p==='search')renderSavedList();
}));
document.querySelectorAll('.desktop-nav-btn').forEach(btn=>btn.addEventListener('click',()=>{
  const p=btn.dataset.page;
  if(p==='home'&&!STATE.collections?.length)return;
  showPage(p);setActiveNav(p);if(p==='search')renderSavedList();
}));

function goToSearch(){showPage('search');setActiveNav('search');clearFeedback();renderSavedList();if(STATE.address)document.getElementById('search-input').value=STATE.address;}
document.getElementById('btn-change').addEventListener('click',goToSearch);
document.getElementById('addr-change').addEventListener('click',goToSearch);
document.getElementById('btn-search').addEventListener('click',()=>doSearch(document.getElementById('search-input').value.trim()));
document.getElementById('search-input').addEventListener('keydown',e=>{if(e.key==='Enter')doSearch(e.target.value.trim());});
document.getElementById('btn-gps').addEventListener('click',doGPS);

document.getElementById('btn-save').addEventListener('click',()=>{if(!isSaved(STATE.viewHref))saveCurrentAddress();});
document.getElementById('btn-notify').addEventListener('click',async()=>{
  if(!STATE.viewHref)return;
  const saved=findSaved(STATE.viewHref);
  if(!saved){showToast('Save this address first, then enable reminders');return;}
  if(saved.notifyEnabled){saved.notifyEnabled=false;saveSaved();updateNotifyBtn();showToast('üîï Reminders turned off');clearNotifTimers();return;}
  const granted=await requestNotifications();if(!granted)return;
  saved.notifyEnabled=true;saveSaved();updateNotifyBtn();scheduleNotifications(STATE.collections,STATE.address.split(',')[0]);showToast("üîî You'll be reminded at 8pm the evening before!");
});
document.getElementById('btn-share').addEventListener('click',doShare);
document.getElementById('btn-refresh').addEventListener('click',async()=>{
  if(!STATE.viewHref)return;
  document.getElementById('stale-bar').innerHTML='<span class="spinner spinner-blue" style="width:12px;height:12px;border-width:2px"></span><span style="margin-left:8px;font-size:11.5px">Refreshing‚Ä¶</span>';
  try{
    const cols=await fetchSchedule(STATE.viewHref);if(!cols.length)throw new Error('No data');
    STATE.collections=cols;STATE.savedAt=Date.now();STATE.dayName=cols[0].dayName;STATE.night=cols[0].night;saveState();
    const saved=findSaved(STATE.viewHref);if(saved){saved.dayName=STATE.dayName;saved.night=STATE.night;saveSaved();}
    renderHome();showToast('‚úÖ Schedule updated!');if(notifEnabled())scheduleNotifications(cols,STATE.address.split(',')[0]);
  }catch(err){updateStaleBar();showToast('Failed to refresh ‚Äî try again later');}
});

// ‚îÄ‚îÄ ONBOARDING ‚îÄ‚îÄ
let installPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();installPrompt=e;});

function buildOnboardingContent(){
  const steps=document.getElementById('onboard-steps');
  const sub=document.getElementById('onboard-sub');
  const cta=document.getElementById('btn-onboard-install');

  if(isIOS){
    sub.textContent='Add Bin Night to your home screen in Safari ‚Äî opens full screen like a native app, no App Store needed.';
    steps.innerHTML=`
      <div class="onboard-step">
        <div class="step-num">1</div>
        <div class="step-body"><div class="step-title">Open in Safari</div><div class="step-desc">This only works from Safari, not Chrome or other browsers.</div></div>
        <div class="step-visual"><div class="step-icon-wrap c-blue">üß≠</div></div>
      </div>
      <div class="onboard-step">
        <div class="step-num">2</div>
        <div class="step-body"><div class="step-title">Tap the Share button</div><div class="step-desc">Tap the box-with-arrow Share icon in Safari's bottom toolbar.</div></div>
        <div class="step-visual"><div class="step-icon-wrap c-blue">‚¨ÜÔ∏è</div></div>
      </div>
      <div class="onboard-step">
        <div class="step-num">3</div>
        <div class="step-body"><div class="step-title">Tap "Add to Home Screen"</div><div class="step-desc">Scroll down in the share sheet and tap the option with the + icon.</div></div>
        <div class="step-visual"><div class="step-icon-wrap c-amber">‚ûï</div></div>
      </div>
      <div class="onboard-step">
        <div class="step-num">4</div>
        <div class="step-body"><div class="step-title">Tap Add ‚Äî you're done!</div><div class="step-desc">Bin Night appears on your home screen and opens full screen.</div></div>
        <div class="step-visual"><div class="step-icon-wrap c-green">üóëÔ∏è</div></div>
      </div>`;
  } else if(isAndroid){
    sub.textContent='Install Bin Night to your home screen ‚Äî opens full screen like a native app, no Play Store needed.';
    if(installPrompt){
      cta.classList.remove('hidden');
      cta.onclick=async()=>{installPrompt.prompt();const{outcome}=await installPrompt.userChoice;if(outcome==='accepted')closeOnboarding(true);};
      steps.innerHTML=`
        <div class="onboard-step">
          <div class="step-num">1</div>
          <div class="step-body"><div class="step-title">Tap Install below</div><div class="step-desc">Chrome will ask to install ‚Äî tap Install in the prompt.</div></div>
          <div class="step-visual"><div class="step-icon-wrap c-blue">üì≤</div></div>
        </div>
        <div class="onboard-step">
          <div class="step-num">2</div>
          <div class="step-body"><div class="step-title">Open from your home screen</div><div class="step-desc">Bin Night appears in your app drawer ‚Äî opens instantly, full screen.</div></div>
          <div class="step-visual"><div class="step-icon-wrap c-green">üóëÔ∏è</div></div>
        </div>`;
    } else {
      steps.innerHTML=`
        <div class="onboard-step">
          <div class="step-num">1</div>
          <div class="step-body"><div class="step-title">Tap the Chrome menu ‚ãÆ</div><div class="step-desc">Tap the three-dot menu in the top-right of Chrome.</div></div>
          <div class="step-visual"><div class="step-icon-wrap c-blue">‚ãÆ</div></div>
        </div>
        <div class="onboard-step">
          <div class="step-num">2</div>
          <div class="step-body"><div class="step-title">Tap "Add to Home screen"</div><div class="step-desc">Find and tap the option in the menu.</div></div>
          <div class="step-visual"><div class="step-icon-wrap c-amber">‚ûï</div></div>
        </div>
        <div class="onboard-step">
          <div class="step-num">3</div>
          <div class="step-body"><div class="step-title">Tap Add ‚Äî you're done!</div><div class="step-desc">Bin Night appears on your home screen and opens full screen.</div></div>
          <div class="step-visual"><div class="step-icon-wrap c-green">üóëÔ∏è</div></div>
        </div>`;
    }
  }
}

function showOnboarding(){buildOnboardingContent();document.getElementById('onboard-overlay').classList.remove('hidden');}

function closeOnboarding(permanent){
  document.getElementById('onboard-overlay').classList.add('hidden');
  document.getElementById('ios-arrow').classList.remove('show');
  if(permanent)localStorage.setItem('bn_install_done','1');
  else localStorage.setItem('bn_onboard_snoozed',Date.now());
}

document.getElementById('onboard-close').addEventListener('click',()=>closeOnboarding(false));
document.getElementById('btn-onboard-dismiss').addEventListener('click',()=>{
  closeOnboarding(false);
  // For iOS, show the persistent arrow pointing to share button after dismissal
  if(isIOS){setTimeout(()=>{document.getElementById('ios-arrow').classList.add('show');setTimeout(()=>document.getElementById('ios-arrow').classList.remove('show'),8000);},400);}
});
document.getElementById('onboard-overlay').addEventListener('click',e=>{if(e.target===document.getElementById('onboard-overlay'))closeOnboarding(false);});

function shouldShowOnboarding(){
  if(isStandalone||isDesktop)return false;
  if(!isIOS&&!isAndroid)return false;
  if(localStorage.getItem('bn_install_done'))return false;
  const snoozed=localStorage.getItem('bn_onboard_snoozed');
  if(snoozed&&Date.now()-+snoozed<3*24*60*60*1000)return false;
  return true;
}

// Inline install banner (shows after onboarding or from Chrome's beforeinstallprompt)
const ib=document.getElementById('install-banner');
ib.addEventListener('click',async()=>{
  if(installPrompt){installPrompt.prompt();const{outcome}=await installPrompt.userChoice;if(outcome==='accepted'){ib.classList.add('hidden');installPrompt=null;localStorage.setItem('bn_install_done','1');}}
  else showOnboarding();
});

// ‚îÄ‚îÄ PWA ‚îÄ‚îÄ
const manifest={name:'Bin Night Guernsey',short_name:'Bin Night',description:'Know exactly what to put out tonight.',start_url:'./',display:'standalone',orientation:'portrait-primary',theme_color:'#060f1c',background_color:'#060f1c',icons:[{src:"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='100' fill='%23060f1c'/><rect x='150' y='215' width='212' height='200' rx='22' fill='%233db8f5' opacity='.9'/><rect x='128' y='158' width='256' height='60' rx='20' fill='%233db8f5'/><path d='M196 120 L196 158 M256 108 L256 158 M316 120 L316 158' stroke='%233db8f5' stroke-width='18' stroke-linecap='round'/></svg>",sizes:'512x512',type:'image/svg+xml',purpose:'any maskable'}]};
const mBlob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
document.head.appendChild(Object.assign(document.createElement('link'),{rel:'manifest',href:URL.createObjectURL(mBlob)}));
document.head.appendChild(Object.assign(document.createElement('link'),{rel:'apple-touch-icon',href:manifest.icons[0].src}));
if('serviceWorker' in navigator){
  const sw="const V='bn-v6';self.addEventListener('install',e=>{e.waitUntil(caches.open(V).then(c=>c.addAll(['./'])).then(()=>self.skipWaiting()))});self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==V).map(k=>caches.delete(k)))).then(()=>self.clients.claim()))});self.addEventListener('fetch',e=>{if(e.request.method!=='GET')return;e.respondWith(caches.match(e.request).then(h=>h||fetch(e.request).then(r=>{const c=r.clone();caches.open(V).then(ca=>ca.put(e.request,c));return r}).catch(()=>caches.match('./'))))});";
  try{navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'application/javascript'})),{scope:'./'});}catch(_){}
}

function scheduleMidnight(){const now=new Date(),next=new Date(now);next.setDate(now.getDate()+1);next.setHours(0,1,0,0);setTimeout(()=>{if(STATE.collections?.length)renderHome();scheduleMidnight();},next-now);}

(async function init(){
  loadSaved();loadState();
  if(isDesktop)document.getElementById('page-search').classList.add('active');

  const params=new URLSearchParams(window.location.search);
  const viewParam=params.get('view');
  if(viewParam){
    showFeedback('<div class="msg info"><span class="msg-icon">‚è≥</span><span>Loading shared schedule‚Ä¶</span></div>');
    try{
      const cols=await fetchSchedule(viewParam);
      if(cols.length){
        const h=await proxyFetch(FUSION+viewParam,false);
        const tm=(typeof h==='string'?h:'').match(/<h4[^>]*class="text-center"[^>]*>([^<]+)<\/h4>/i);
        STATE={address:tm?tm[1].trim():'Shared address',viewHref:viewParam,dayName:cols[0].dayName,night:cols[0].night,collections:cols,savedAt:Date.now()};
        saveState();clearFeedback();renderHome();window.history.replaceState({},'',window.location.pathname);
      }else showFeedback('<div class="msg error"><span class="msg-icon">‚ö†Ô∏è</span><span>Couldn\'t load the shared schedule.</span></div>');
    }catch(_){showFeedback('<div class="msg error"><span class="msg-icon">üåê</span><span>Couldn\'t load the shared schedule.</span></div>');}
  } else if(STATE.collections?.length){
    renderHome();
    SAVED.filter(s=>s.notifyEnabled).forEach(s=>{if(s.viewHref===STATE.viewHref&&Notification.permission==='granted')scheduleNotifications(STATE.collections,STATE.address.split(',')[0]);});
  }

  renderSavedList();
  scheduleMidnight();
  if(shouldShowOnboarding())setTimeout(showOnboarding,1800);
})();
</script>
</body>
</html>
